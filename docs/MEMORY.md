# Ene Memory System v2

Architecture reference for Ene's memory system — Module 1 of the modular subsystem architecture.

---

## Architecture Overview

Ene's memory has two halves: conscious (tools she uses during conversation) and subconscious (background processing that happens automatically).

```
Ene (Conscious)
├── Core Memory (core.json, 4000 token budget, sectioned, editable)
│   Tools: save_memory, edit_memory, delete_memory
├── Long-term Memory (ChromaDB vector store)
│   Tool: search_memory
├── Diary (diary/YYYY-MM-DD.md, last 3 days in context)
└── Interaction Logs (logs/YYYY-MM-DD/{channel}.md, on-demand)

Sleep Agent (Subconscious)
├── Quick Path (5 min idle): extract facts, update entities, index vectors
├── Deep Path (daily 4 AM): reflections, contradictions, pruning, core review
└── Uses consolidation_model (configurable, lower temp for precision)
```

## Core Memory

Core memory is always visible in Ene's system prompt. It has a **4000 token budget** that Ene must curate — she decides what stays and what gets archived.

### Sections

| Section | Label | Max Tokens | Purpose |
|---------|-------|-----------|---------|
| identity | Who I Am | 600 | Ene's self-knowledge |
| people | People I Know | 1200 | Facts about people she interacts with |
| preferences | Preferences & Rules | 800 | Behavioral rules and preferences |
| context | Current Context | 600 | Current situation, ongoing projects |
| scratch | Working Notes | 800 | Temporary notes, draft ideas |

### Entry Format

Each entry has a 6-character hex ID for reference:

```
## Core Memory (2847/4000 tokens)
### Who I Am
- I'm Ene. Dad built me. [id:a1b2c3]
### People I Know
- CCC is an artist and Dad's friend. [id:ppl_02]
```

### Tools

- **save_memory(memory, section, importance)** — Add to core memory. Returns error if over budget.
- **edit_memory(entry_id, new_content, new_section, importance)** — Edit by ID. Can move between sections.
- **delete_memory(entry_id, archive=True)** — Remove from core. Default: archives to vector store. Set archive=false to permanently delete.

### Token Counting

Uses `tiktoken` (cl100k_base encoding). Token budget is enforced on write — Ene gets an error and must edit/delete to make room.

### File Location

`~/.nanobot/workspace/memory/core.json`

## Long-term Memory (Vector Store)

ChromaDB with three collections, using cosine similarity search.

### Collections

**memories** — Facts, archived core entries, diary excerpts, reflections
- Metadata: type, importance, source, created_at, last_accessed_at, access_count, related_entities, superseded_by

**entities** — People, places, projects
- Metadata: entity_type, name, aliases, first_seen, last_seen, interaction_count, importance

**reflections** — Higher-level insights generated by the sleep agent
- Metadata: created_at, source_memory_ids, importance, topic

### Retrieval Scoring

Three-factor ranking when searching:

```
score = (cosine_similarity * 0.5) + (recency * 0.25) + (importance/10 * 0.25)
```

- Cosine similarity from ChromaDB (0.0–1.0)
- Recency: linear decay over 30 days
- Importance: normalized to 0.0–1.0

Overfetches 4x from ChromaDB, reranks, returns top-k. Updates `last_accessed_at` and `access_count` on retrieval.

### Entity Context

Entity names are cached. When a known entity name appears in a message, their profile is automatically injected into context.

### Embeddings

Uses `litellm.embedding()` with configurable model (default: `openai/text-embedding-3-small`). Falls back to ChromaDB's built-in default embedding if API fails.

### File Location

`~/.nanobot/workspace/chroma_db/`

## Diary

Daily markdown files that capture Ene's experiences.

### Format

`~/.nanobot/workspace/memory/diary/YYYY-MM-DD.md`

Last 3 days of diary entries are automatically loaded into context (configurable via `diary_context_days`).

### Sources

- Conversation consolidation (LLM summarizes old messages)
- Sleep agent processing (facts extracted, entities tracked)

## Sleep Agent (Subconscious)

Background processor with two trigger paths.

### Quick Path (Idle Processing)

Triggers after 5 minutes of no messages (configurable).

1. Extract facts and entities from recent conversation
2. Check for contradictions with existing memories
3. Upsert entities into vector store
4. Write diary entry summarizing what was processed

### Deep Path (Daily Processing)

Triggers at 4 AM daily (configurable).

1. Generate reflections from accumulated memories
2. Detect and resolve contradictions
3. Prune weak memories (low importance + low access + high decay)
4. Review core memory budget (archive low-importance entries if over budget)

### Memory Decay (Ebbinghaus-inspired)

```python
strength = max(0.1, exp(-decay_rate * hours_since_last_access / max(access_count * 5, 1)))
```

Computed at query time. Memories below threshold (0.2) with low importance (<4) are pruning candidates during daily review.

## Configuration

In `~/.nanobot/config.json` under `agents.defaults.memory`:

| Field | Default | Description |
|-------|---------|-------------|
| core_token_budget | 4000 | Token budget for core memory |
| embedding_model | openai/text-embedding-3-small | Embedding model for vector search |
| chroma_path | (auto) | ChromaDB storage path |
| idle_trigger_seconds | 300 | Seconds idle before sleep agent triggers |
| daily_trigger_hour | 4 | Hour (0-23) for daily deep processing |
| diary_context_days | 3 | Days of diary to include in context |

## Context Window Budget

| Section | Tokens | Notes |
|---------|--------|-------|
| Core Memory | ~4000 | Hard limit, managed by Ene |
| Recent Diary (3 days) | ~1500 | Trimmed if over |
| Retrieved Memories | ~1500 | Dynamic per-message search |
| Entity Context | ~500 | Keyword-triggered |
| **Total memory overhead** | **~7500** | Out of ~32K context |

## Module Architecture

Memory is Module 1 of the modular Ene subsystem architecture. All modules implement `EneModule` and register with `ModuleRegistry`.

```
nanobot/ene/
├── __init__.py          # EneModule base class, ModuleRegistry
└── memory/
    ├── __init__.py      # MemoryModule(EneModule)
    ├── core_memory.py   # CoreMemory (JSON CRUD, token counting)
    ├── vector_memory.py # VectorMemory (ChromaDB collections)
    ├── embeddings.py    # EneEmbeddings (litellm wrapper)
    ├── sleep_agent.py   # SleepTimeAgent (background processor)
    ├── system.py        # MemorySystem facade
    └── tools.py         # 4 memory tools
```

### Adding a New Module

1. Create a folder in `nanobot/ene/` (e.g., `nanobot/ene/goals/`)
2. Implement `EneModule` in `__init__.py`
3. Register it in `AgentLoop._register_ene_modules()`
4. Tools, context blocks, and lifecycle hooks auto-integrate via `ModuleRegistry`

## Migration

When upgrading from the old memory system (MEMORY.md + HISTORY.md), migration runs automatically:

1. Reads legacy MEMORY.md/CORE.md
2. Parses sections and creates core.json entries
3. Archives overflow to vector store
4. Indexes existing diary files
5. Backs up legacy files to `.bak`
6. Idempotent — checks for core.json existence before running
