<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ene ‚Äî Live Trace</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/live.css">
</head>
<body class="live-body">
    <!-- Header -->
    <header id="status-bar">
        <div class="status-left">
            <span class="logo">Ene Live Trace</span>
            <a href="/" class="nav-link">Metrics</a>
            <a href="/status" class="nav-link">Status</a>
            <a href="/control" class="nav-link">Control</a>
            <a href="/threads" class="nav-link">Threads</a>
            <a href="/settings" class="nav-link">Settings</a>
            <span id="connection-badge" class="badge">connecting</span>
        </div>
        <div class="status-right">
            <select id="model-select" class="model-select" title="Switch LLM model">
                <option value="">Loading...</option>
            </select>
            <button id="brain-indicator" class="ctrl-btn brain-btn" title="Click to toggle brain on/off">üß† --</button>
            <button id="btn-hard-reset" class="ctrl-btn ctrl-btn-danger" title="Drop all queues, clear session, fresh start">‚ö° Hard Reset</button>
            <button id="btn-clear" class="ctrl-btn" title="Clear timeline">Clear</button>
            <button id="btn-pause" class="ctrl-btn" title="Pause auto-scroll">‚è∏ Pause</button>
            <span id="event-count">0 events</span>
        </div>
    </header>

    <div class="live-layout">
        <!-- Left Panel: Queue State -->
        <aside id="state-panel">
            <section class="state-section">
                <h3>Pipeline State</h3>
                <div class="state-grid">
                    <div class="state-item">
                        <span class="state-label">Buffers</span>
                        <span class="state-value" id="st-buffers">0</span>
                    </div>
                    <div class="state-item">
                        <span class="state-label">Queued</span>
                        <span class="state-value" id="st-queues">0</span>
                    </div>
                    <div class="state-item">
                        <span class="state-label">Processing</span>
                        <span class="state-value" id="st-processing">‚Äî</span>
                    </div>
                    <div class="state-item">
                        <span class="state-label">Muted</span>
                        <span class="state-value" id="st-muted">0</span>
                    </div>
                    <div class="state-item">
                        <span class="state-label">Model</span>
                        <span class="state-value" id="st-model" title="">‚Äî</span>
                    </div>
                </div>
            </section>

            <section class="state-section">
                <h3>Active Batch</h3>
                <div id="active-batch" class="batch-info">
                    <span class="muted">No active batch</span>
                </div>
            </section>

            <section class="state-section">
                <h3>Rolling Stats</h3>
                <div class="state-grid">
                    <div class="state-item">
                        <span class="state-label">Received</span>
                        <span class="state-value state-value-sm" id="st-received">0</span>
                    </div>
                    <div class="state-item">
                        <span class="state-label">Responded</span>
                        <span class="state-value state-value-sm" id="st-responded">0</span>
                    </div>
                    <div class="state-item">
                        <span class="state-label">Lurked</span>
                        <span class="state-value state-value-sm" id="st-lurked">0</span>
                    </div>
                    <div class="state-item">
                        <span class="state-label">Avg Latency</span>
                        <span class="state-value state-value-sm" id="st-avg-latency">‚Äî</span>
                    </div>
                </div>
            </section>

            <section class="state-section">
                <h3>Last Activity</h3>
                <div class="activity-list">
                    <div class="activity-row">
                        <span class="activity-label">Message</span>
                        <span class="activity-value" id="st-last-msg">‚Äî</span>
                    </div>
                    <div class="activity-row">
                        <span class="activity-label">Response</span>
                        <span class="activity-value" id="st-last-resp">‚Äî</span>
                    </div>
                    <div class="activity-row">
                        <span class="activity-label">Daemon</span>
                        <span class="activity-value" id="st-last-daemon">‚Äî</span>
                    </div>
                </div>
            </section>

            <section class="state-section">
                <h3>Module Health</h3>
                <div id="module-health" class="module-health">
                    <span class="muted">Loading...</span>
                </div>
            </section>

            <section class="state-section">
                <h3>Cost by Model <span id="cost-period" class="ctx-badge">7d</span></h3>
                <div id="cost-by-model" class="cost-breakdown">
                    <span class="muted">Loading...</span>
                </div>
            </section>

            <section class="state-section">
                <h3>Legend</h3>
                <div class="legend">
                    <div class="legend-item"><span class="dot dot-arrival"></span> Arrival</div>
                    <div class="legend-item"><span class="dot dot-classify"></span> Classify</div>
                    <div class="legend-item"><span class="dot dot-llm"></span> LLM</div>
                    <div class="legend-item"><span class="dot dot-tool"></span> Tool</div>
                    <div class="legend-item"><span class="dot dot-output"></span> Output</div>
                    <div class="legend-item"><span class="dot dot-error"></span> Error</div>
                    <div class="legend-item"><span class="dot dot-module"></span> Module</div>
                </div>
            </section>
        </aside>

        <!-- Right Panel: Event Timeline -->
        <main id="timeline">
            <div id="events-container">
                <div class="empty-state">
                    <p>Waiting for events...</p>
                    <p class="muted">Send a message on Discord to see the processing pipeline live.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Prompt Log ‚Äî full prompt/response content for debugging -->
    <div id="prompt-log-section">
        <div id="prompt-log-header">
            <span class="prompt-log-title">Prompt Log</span>
            <span class="prompt-log-subtitle">Full daemon + Ene prompts and responses ‚Äî every word</span>
            <div class="prompt-log-controls">
                <span id="prompt-conn-badge" class="badge">connecting</span>
                <button id="btn-prompt-clear" class="ctrl-btn" title="Clear prompt log">Clear</button>
                <button id="btn-prompt-pause" class="ctrl-btn" title="Pause auto-scroll">‚è∏ Pause</button>
                <span id="prompt-count">0 entries</span>
            </div>
        </div>
        <div id="prompt-log-body">
            <div id="prompt-entries">
                <div class="empty-state">
                    <p>Waiting for prompts...</p>
                    <p class="muted">Daemon and Ene prompts will appear here in full.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Panel ‚Äî real-time view of memory, threads, session -->
    <div id="context-section">
        <div id="context-header">
            <span class="context-title">Context Inspector</span>
            <span class="context-subtitle">What Ene currently knows ‚Äî memory, threads, session history</span>
            <div class="context-controls">
                <span id="context-status" class="badge">loading</span>
                <label class="ctx-toggle" title="Auto-refresh every 5s">
                    <input type="checkbox" id="ctx-auto-refresh" checked> Auto
                </label>
                <button id="btn-ctx-refresh" class="ctrl-btn" title="Refresh now">‚Üª Refresh</button>
            </div>
        </div>
        <div id="context-body">
            <div class="ctx-panels">
                <!-- Memory Panel -->
                <div class="ctx-panel" id="ctx-memory">
                    <h4>üß† Core Memory <span id="ctx-mem-budget" class="ctx-badge"></span></h4>
                    <div id="ctx-mem-sections"></div>
                </div>
                <!-- Threads Panel -->
                <div class="ctx-panel" id="ctx-threads">
                    <h4>üí¨ Active Threads <span id="ctx-thread-count" class="ctx-badge"></span></h4>
                    <div id="ctx-thread-list"></div>
                    <div id="ctx-pending-wrap">
                        <h5>Pending (unassigned)</h5>
                        <div id="ctx-pending-list"></div>
                    </div>
                </div>
                <!-- Session Panel -->
                <div class="ctx-panel" id="ctx-sessions">
                    <h4>üìã Session History <span id="ctx-session-info" class="ctx-badge"></span></h4>
                    <div id="ctx-session-messages"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/live.js"></script>
</body>
</html>
